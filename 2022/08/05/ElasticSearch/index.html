<!DOCTYPE html>
<html lang=zh-CN>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta property="og:description" content="江流的博客">
    <meta property="og:type" content="website">
    <meta name="description" content="江流的博客">
    <meta name="keyword"  content="江流的博客，Java开发">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>
        
        《ElasticSearch基础》 - JiangLiu 日常
        
    </title>

    <!-- Custom CSS -->
    
<link rel="stylesheet" href="/css/aircloud.css">

    
<link rel="stylesheet" href="/css/gitment.css">

    <!--<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">-->
    <link href="//at.alicdn.com/t/font_620856_28hi1hpxx24.css" rel="stylesheet" type="text/css">
    <!-- ga & ba script hoook -->
    <script></script>
<meta name="generator" content="Hexo 5.4.2"><link rel="alternate" href="/atom.xml" title="江流的个人博客" type="application/atom+xml">
</head>

<body>

<div class="site-nav-toggle" id="site-nav-toggle">
    <button>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
    </button>
</div>

<div class="index-about">
    <i> 一名落魄的Java程序员 </i>
</div>

<div class="index-container">
    
    <div class="index-left">
        
<div class="nav" id="nav">
    <div class="avatar-name">
        <div class="avatar ">
            <img src="/img/avatar.jpg" />
        </div>
        <div class="name">
            <i>JiangLiu</i>
        </div>
    </div>
    <div class="contents" id="nav-content">
        <ul>
            <li >
                <a href="/">
                    <i class="iconfont icon-shouye1"></i>
                    <span>主页</span>
                </a>
            </li>
            <li >
                <a href="/tags">
                    <i class="iconfont icon-biaoqian1"></i>
                    <span>标签</span>
                </a>
            </li>
            <li >
                <a href="/archive">
                    <i class="iconfont icon-guidang2"></i>
                    <span>存档</span>
                </a>
            </li>
            <li >
                <a href="/collect/">
                    <i class="iconfont icon-shoucang1"></i>
                    <span>收藏</span>
                </a>
            </li>
            <li >
                <a href="/about/">
                    <i class="iconfont icon-guanyu2"></i>
                    <span>关于</span>
                </a>
            </li>
            
            <li>
                <a id="search">
                    <i class="iconfont icon-sousuo1"></i>
                    <span>搜索</span>
                </a>
            </li>
            
        </ul>
    </div>
    
        <div id="toc" class="toc-article">
    <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8"><span class="toc-text">基础入门</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E4%BA%9B%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5"><span class="toc-text">一些基础概念</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%87%E6%A1%A3"><span class="toc-text">文档</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#index%E5%92%8Ctype%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="toc-text">index和type的区别</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#index"><span class="toc-text">index</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#type"><span class="toc-text">type</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E8%BE%93%E5%85%A5%E5%92%8C%E8%BE%93%E5%87%BA"><span class="toc-text">数据输入和输出</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B4%A2%E5%BC%95%E6%96%87%E6%A1%A3"><span class="toc-text">索引文档</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E8%87%AA%E5%AE%9A%E4%B9%89ID"><span class="toc-text">使用自定义ID</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%87%AA%E5%8A%A8%E7%94%9F%E6%88%90ID"><span class="toc-text">自动生成ID</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%96%E5%9B%9E%E4%B8%80%E4%B8%AA%E6%96%87%E6%A1%A3"><span class="toc-text">取回一个文档</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A3%80%E6%9F%A5%E6%96%87%E6%A1%A3%E6%98%AF%E5%90%A6%E5%AD%98%E5%9C%A8"><span class="toc-text">检查文档是否存在</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9B%B4%E6%96%B0%E6%95%B4%E4%B8%AA%E6%96%87%E6%A1%A3"><span class="toc-text">更新整个文档</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E6%96%B0%E7%9A%84%E6%96%87%E6%A1%A3"><span class="toc-text">创建一个新的文档</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E7%A7%8D"><span class="toc-text">第一种</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E7%A7%8D"><span class="toc-text">第二种</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E7%A7%8D"><span class="toc-text">第三种</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A0%E9%99%A4%E6%96%87%E6%A1%A3"><span class="toc-text">删除文档</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%84%E7%90%86%E5%86%B2%E7%AA%81"><span class="toc-text">处理冲突</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%82%B2%E8%A7%82%E9%94%81"><span class="toc-text">悲观锁</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B9%90%E8%A7%82%E9%94%81"><span class="toc-text">乐观锁</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B9%90%E8%A7%82%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6"><span class="toc-text">乐观并发控制</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%9A%E8%BF%87%E5%A4%96%E9%83%A8%E7%B3%BB%E7%BB%9F%E4%BD%BF%E7%94%A8%E7%89%88%E6%9C%AC%E6%8E%A7%E5%88%B6"><span class="toc-text">通过外部系统使用版本控制</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%87%E6%A1%A3%E9%83%A8%E5%88%86%E6%9B%B4%E6%96%B0"><span class="toc-text">文档部分更新</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E8%84%9A%E6%9C%AC%E6%9B%B4%E6%96%B0%E6%96%87%E6%A1%A3"><span class="toc-text">使用脚本更新文档</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9B%B4%E6%96%B0%E7%9A%84%E6%96%87%E6%A1%A3%E5%8F%AF%E8%83%BD%E4%B8%8A%E4%B8%8D%E5%AD%98%E5%9C%A8"><span class="toc-text">更新的文档可能上不存在</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9B%B4%E6%96%B0%E5%92%8C%E5%86%B2%E7%AA%81"><span class="toc-text">更新和冲突</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%96%E5%9B%9E%E5%A4%9A%E4%B8%AA%E6%96%87%E6%A1%A3"><span class="toc-text">取回多个文档</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#megt"><span class="toc-text">megt</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E4%BB%B7%E8%BE%83%E5%B0%8F%E7%9A%84%E6%89%B9%E9%87%8F%E6%93%8D%E4%BD%9C"><span class="toc-text">代价较小的批量操作</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E6%96%87%E6%A1%A3%E5%AD%98%E5%82%A8"><span class="toc-text">分布式文档存储</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1%E4%B8%80%E4%B8%AA%E6%96%87%E6%A1%A3%E5%88%B0%E4%B8%80%E4%B8%AA%E5%88%86%E7%89%87%E4%B8%AD"><span class="toc-text">路由一个文档到一个分片中</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BB%E5%88%86%E7%89%87%E5%92%8C%E5%89%AF%E6%9C%AC%E5%88%86%E7%89%87%E7%9A%84%E4%BA%A4%E4%BA%92"><span class="toc-text">主分片和副本分片的交互</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B0%E5%BB%BA%E3%80%81%E7%B4%A2%E5%BC%95%E5%92%8C%E5%88%A0%E9%99%A4%E6%96%87%E6%A1%A3"><span class="toc-text">新建、索引和删除文档</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#consistency"><span class="toc-text">consistency</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#timeout"><span class="toc-text">timeout</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%96%E5%9B%9E%E4%B8%80%E4%B8%AA%E6%96%87%E6%A1%A3-1"><span class="toc-text">取回一个文档</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B1%80%E9%83%A8%E6%9B%B4%E6%96%B0%E6%96%87%E6%A1%A3"><span class="toc-text">局部更新文档</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%9A%E6%96%87%E6%A1%A3%E6%A8%A1%E5%BC%8F"><span class="toc-text">多文档模式</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%80%E5%9F%BA%E6%9C%AC%E7%9A%84%E5%B7%A5%E5%85%B7%E2%80%94%E2%80%94%E6%90%9C%E7%B4%A2"><span class="toc-text">最基本的工具——搜索</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A9%BA%E6%90%9C%E7%B4%A2"><span class="toc-text">空搜索</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%9A%E7%B4%A2%E5%BC%95%E3%80%81%E5%A4%9A%E7%B1%BB%E5%9E%8B"><span class="toc-text">多索引、多类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E9%A1%B5"><span class="toc-text">分页</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BD%BB%E9%87%8F%E6%90%9C%E7%B4%A2"><span class="toc-text">轻量搜索</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%90%9C%E7%B4%A2"><span class="toc-text">查询字符串搜索</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#all%E5%AD%97%E6%AE%B5"><span class="toc-text">_all字段</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%98%A0%E5%B0%84%E5%92%8C%E5%88%86%E6%9E%90"><span class="toc-text">映射和分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B2%BE%E7%A1%AE%E5%80%BC-VS-%E5%85%A8%E6%96%87"><span class="toc-text">精确值 VS 全文</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%80%92%E6%8E%92%E7%B4%A2%E5%BC%95"><span class="toc-text">倒排索引</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90%E5%92%8C%E5%88%86%E6%9E%90%E5%99%A8"><span class="toc-text">分析和分析器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%85%E7%BD%AE%E5%88%86%E6%9E%90%E5%99%A8"><span class="toc-text">内置分析器</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%A0%87%E5%87%86%E5%88%86%E6%9E%90%E5%99%A8"><span class="toc-text">标准分析器</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%AE%80%E5%8D%95%E5%88%86%E6%9E%90%E5%99%A8"><span class="toc-text">简单分析器</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%A9%BA%E6%A0%BC%E5%88%86%E6%9E%90%E5%99%A8"><span class="toc-text">空格分析器</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%AF%AD%E8%A8%80%E5%88%86%E6%9E%90%E5%99%A8"><span class="toc-text">语言分析器</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%97%B6%E5%80%99%E4%BD%BF%E7%94%A8%E5%88%86%E6%9E%90%E5%99%A8"><span class="toc-text">什么时候使用分析器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E5%88%86%E6%9E%90%E5%99%A8"><span class="toc-text">测试分析器</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%98%A0%E5%B0%84"><span class="toc-text">映射</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E6%98%A0%E5%B0%84"><span class="toc-text">查看映射</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E5%9F%9F%E6%98%A0%E5%B0%84"><span class="toc-text">自定义域映射</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#index-1"><span class="toc-text">index</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#analyzer"><span class="toc-text">analyzer</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9B%B4%E6%96%B0%E6%98%A0%E5%B0%84"><span class="toc-text">更新映射</span></a></li></ol></li></ol></li></ol></li></ol>
</div>
    
</div>


<div class="search-field" id="search-field">
    <div class="search-container">
        <div class="search-input">
            <span id="esc-search"> <i class="icon-fanhui iconfont"></i></span>
            <input id="search-input"/>
            <span id="begin-search">搜索</span>
        </div>
        <div class="search-result-container" id="search-result-container">

        </div>
    </div>
</div>

        <div class="index-about-mobile">
            <i> 一名落魄的Java程序员 </i>
        </div>
    </div>
    
    <div class="index-middle">
        <!-- Main Content -->
        


<div class="post-container">
    <div class="post-title">
        《ElasticSearch基础》
    </div>

    <div class="post-meta">
        <span class="attr">发布于：<span>2022-08-05 00:00:00</span></span>
        
        <span class="attr">标签：/
        
        <a class="tag" href="/tags/#ElasticSearch" title="ElasticSearch">ElasticSearch</a>
        <span>/</span>
        
        
        </span>
        <span class="attr">访问：<span id="busuanzi_value_page_pv"></span>
</span>
</span>
    </div>
    <div class="post-content no-indent">
        <h1 id="基础入门"><a href="#基础入门" class="headerlink" title="基础入门"></a>基础入门</h1><h2 id="一些基础概念"><a href="#一些基础概念" class="headerlink" title="一些基础概念"></a>一些基础概念</h2><h3 id="文档"><a href="#文档" class="headerlink" title="文档"></a>文档</h3><p>在大多数语言中，实体类可以被序列化为键值对形式的json，通常情况下，我们的<code>对象</code>和<code>文档</code>两个概念是可以相互替换的。</p>
<h3 id="index和type的区别"><a href="#index和type的区别" class="headerlink" title="index和type的区别"></a>index和type的区别</h3><h4 id="index"><a href="#index" class="headerlink" title="index"></a>index</h4><p>为了将数据添加到ES，我们需要一个索引<code>index</code>，就是一个存储关联数据的地方，实际上，索引是一个用来指定一个或多个分片的”逻辑命名空间”</p>
<p>注意：索引在磁盘空间、内存使用等方面有一个小而固定的开销，因此一个大的索引比多个小的索引效率更高。</p>
<h4 id="type"><a href="#type" class="headerlink" title="type"></a>type</h4><p>文档表示的对象类别</p>
<p>type允许我们在一个索引中存储多种类型的数据，在es中，数据存放在索引中可能是非常混乱的，这时候我们指定一个子分区就非常有用了</p>
<p>比如：所有的产品放在一个index中，但是这些产品种类繁多，这时我们就可以指定一些子分区type，比如电子产品type、厨房用具type…</p>
<p>它允许我们在索引中进行逻辑分区</p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">如果还是不能理解，可以把index理解成一个数据库，而type就是数据库中的表，但是这样有问题，他们两个的数据存储方式不同，以至于这么比较完全没有意义。</span><br></pre></td></tr></table></figure>



<h2 id="数据输入和输出"><a href="#数据输入和输出" class="headerlink" title="数据输入和输出"></a>数据输入和输出</h2><h3 id="索引文档"><a href="#索引文档" class="headerlink" title="索引文档"></a>索引文档</h3><p>在es中，<code>_index</code>、<code>_type</code>、<code>_id</code>三个字段可以作为一个文档的唯一标识，_id字段我们可以手动生成，也可以让indexAPI自动生成</p>
<h4 id="使用自定义ID"><a href="#使用自定义ID" class="headerlink" title="使用自定义ID"></a>使用自定义ID</h4><p>格式：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PUT /&#123;index&#125;/&#123;type&#125;/&#123;id&#125;</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;field&quot;</span>: <span class="string">&quot;value&quot;</span>,</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>示例：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PUT /website/blog/<span class="number">123</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;My first blog entry&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;text&quot;</span>:  <span class="string">&quot;Just trying this out...&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;date&quot;</span>:  <span class="string">&quot;2014/01/01&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结果：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   <span class="attr">&quot;_index&quot;</span>:    <span class="string">&quot;website&quot;</span>,</span><br><span class="line">   <span class="attr">&quot;_type&quot;</span>:     <span class="string">&quot;blog&quot;</span>,</span><br><span class="line">   <span class="attr">&quot;_id&quot;</span>:       <span class="string">&quot;123&quot;</span>,</span><br><span class="line">   <span class="attr">&quot;_version&quot;</span>:  <span class="number">1</span>,</span><br><span class="line">   <span class="attr">&quot;created&quot;</span>:   <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>响应中有两个字段:</p>
<ul>
<li>_version：代表当前文档的版本号</li>
<li>created：是否创建成功</li>
</ul>
<p>当然，如果你懒的输入id，或者数据量过大你也不知道ID是多少，也可以让ES帮我们自动生成ID</p>
<h4 id="自动生成ID"><a href="#自动生成ID" class="headerlink" title="自动生成ID"></a>自动生成ID</h4><p>示例：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">POST /website/blog/</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;My second blog entry&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;text&quot;</span>:  <span class="string">&quot;Still trying this out...&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;date&quot;</span>:  <span class="string">&quot;2014/01/01&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>也就是id那个字段设置为空</p>
<p>响应：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   <span class="attr">&quot;_index&quot;</span>:    <span class="string">&quot;website&quot;</span>,</span><br><span class="line">   <span class="attr">&quot;_type&quot;</span>:     <span class="string">&quot;blog&quot;</span>,</span><br><span class="line">   <span class="attr">&quot;_id&quot;</span>:       <span class="string">&quot;AVFgSgVHUP18jI2wRx0w&quot;</span>,</span><br><span class="line">   <span class="attr">&quot;_version&quot;</span>:  <span class="number">1</span>,</span><br><span class="line">   <span class="attr">&quot;created&quot;</span>:   <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在这个响应中，除了ID是ES自动生成，其他都一样</p>
<h3 id="取回一个文档"><a href="#取回一个文档" class="headerlink" title="取回一个文档"></a>取回一个文档</h3><p>如果我们想要从ES中取回文档，仍然使用相同的<code>_index</code>、<code>_type</code>、<code>_id</code>就行</p>
<p>示例：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /website/blog/<span class="number">123</span>?pretty</span><br></pre></td></tr></table></figure>

<p>响应：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;_index&quot;</span> :   <span class="string">&quot;website&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;_type&quot;</span> :    <span class="string">&quot;blog&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;_id&quot;</span> :      <span class="string">&quot;123&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;_version&quot;</span> : <span class="number">1</span>,</span><br><span class="line">  <span class="attr">&quot;found&quot;</span> :    <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">&quot;_source&quot;</span> :  &#123;</span><br><span class="line">      <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;My first blog entry&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;text&quot;</span>:  <span class="string">&quot;Just trying this out...&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;date&quot;</span>:  <span class="string">&quot;2014/01/01&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里又出现了一个新的参数：</p>
<ul>
<li>found：是否查询到数据</li>
</ul>
<p>后面会讲到，在多个文档查询中，文档与文档的查询是相互独立的，如果一个文档没查询到数据，并不会影响到其他文档。</p>
<h3 id="检查文档是否存在"><a href="#检查文档是否存在" class="headerlink" title="检查文档是否存在"></a>检查文档是否存在</h3><p>如果我们只是想检查某个文档是否存在，而并不关心它的内容是什么，那么可以用HEAD来代替GET方法</p>
<p>示例：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -i -XHEAD http:<span class="comment">//localhost:9200/website/blog/123</span></span><br></pre></td></tr></table></figure>

<ul>
<li>-i：打印响应头和网页代码</li>
<li>-X：用指定的请求方式去请求</li>
</ul>
<p>如果文档存在：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">HTTP/<span class="number">1.1</span> <span class="number">200</span> OK</span><br><span class="line">Content-Type: text/plain; charset=UTF<span class="number">-8</span></span><br><span class="line">Content-Length: <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>如果文档不存在：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">HTTP/<span class="number">1.1</span> <span class="number">404</span> Not Found</span><br><span class="line">Content-Type: text/plain; charset=UTF<span class="number">-8</span></span><br><span class="line">Content-Length: <span class="number">0</span></span><br></pre></td></tr></table></figure>

<h3 id="更新整个文档"><a href="#更新整个文档" class="headerlink" title="更新整个文档"></a>更新整个文档</h3><p>在es中，文档是不可变的，如果想要修改，就要更新现有文档，需要重建索引或者进行替换。</p>
<p>这是我们原来的文档</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;_index&quot;</span> :   <span class="string">&quot;website&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;_type&quot;</span> :    <span class="string">&quot;blog&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;_id&quot;</span> :      <span class="string">&quot;123&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;_version&quot;</span> : <span class="number">1</span>,</span><br><span class="line">  <span class="attr">&quot;found&quot;</span> :    <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">&quot;_source&quot;</span> :  &#123;</span><br><span class="line">      <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;My first blog entry&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;text&quot;</span>:  <span class="string">&quot;Just trying this out...&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;date&quot;</span>:  <span class="string">&quot;2014/01/01&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果我们要修改这个文档</p>
<p>示例：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PUT /website/blog/<span class="number">123</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;My first blog entry&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;text&quot;</span>:  <span class="string">&quot;I am starting to get the hang of this...&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;date&quot;</span>:  <span class="string">&quot;2014/01/02&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>响应体：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;_index&quot;</span> :   <span class="string">&quot;website&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;_type&quot;</span> :    <span class="string">&quot;blog&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;_id&quot;</span> :      <span class="string">&quot;123&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;_version&quot;</span> : <span class="number">2</span>,</span><br><span class="line">  <span class="attr">&quot;created&quot;</span>:   <span class="literal">false</span> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在内部，es会将已经被替换掉的文档标记为已删除，并且增加一个新的文档，但是这个旧的文档并不会马上消失，并且你也不能对旧的文档进行访问，当我们继续索引更多的数据时，es会在后台清理这些已经删除的文档。</p>
<h3 id="创建一个新的文档"><a href="#创建一个新的文档" class="headerlink" title="创建一个新的文档"></a>创建一个新的文档</h3><p>如果我们想要创建一个新的文档，怎么保证我们正在创建一个全新文档而不是覆盖旧的文档，有三种方案</p>
<h4 id="第一种"><a href="#第一种" class="headerlink" title="第一种"></a>第一种</h4><p>最简单的办法就是让es自动生成id，我们只指定index和type</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">POST /website/blog/</span><br><span class="line">&#123; ... &#125;</span><br></pre></td></tr></table></figure>

<p>如果你仍然想要指定自己的id，可以参考下面两种方案</p>
<h4 id="第二种"><a href="#第二种" class="headerlink" title="第二种"></a>第二种</h4><p>使用<code>op_type</code>查询字符串参数：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PUT /website/blog/<span class="number">123</span>?op_type=create</span><br></pre></td></tr></table></figure>

<h4 id="第三种"><a href="#第三种" class="headerlink" title="第三种"></a>第三种</h4><p>在URL末端使用<code>/_create</code></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PUT /website/blog/<span class="number">123</span>/_create</span><br></pre></td></tr></table></figure>

<p>如果添加成功，es会返回给我们一个元数据和一个<code>201created</code>的HTTP响应码</p>
<p>如果添加失败，即已经有相同的文档存在，es会返回给我们一个<code>409 Conflict</code>响应码</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   <span class="attr">&quot;error&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;root_cause&quot;</span>: [</span><br><span class="line">         &#123;</span><br><span class="line">            <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;document_already_exists_exception&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;reason&quot;</span>: <span class="string">&quot;[blog][123]: document already exists&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;shard&quot;</span>: <span class="string">&quot;0&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;index&quot;</span>: <span class="string">&quot;website&quot;</span></span><br><span class="line">         &#125;</span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;document_already_exists_exception&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;reason&quot;</span>: <span class="string">&quot;[blog][123]: document already exists&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;shard&quot;</span>: <span class="string">&quot;0&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;index&quot;</span>: <span class="string">&quot;website&quot;</span></span><br><span class="line">   &#125;,</span><br><span class="line">   <span class="attr">&quot;status&quot;</span>: <span class="number">409</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="删除文档"><a href="#删除文档" class="headerlink" title="删除文档"></a>删除文档</h3><p>删除文档非常简单，就是把请求方法换一换</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DELETE /website/blog/<span class="number">123</span></span><br></pre></td></tr></table></figure>

<p>如果找到了该文档，es会返回一个<code>200 ok</code>的响应码</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;found&quot;</span> :    <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">&quot;_index&quot;</span> :   <span class="string">&quot;website&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;_type&quot;</span> :    <span class="string">&quot;blog&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;_id&quot;</span> :      <span class="string">&quot;123&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;_version&quot;</span> : <span class="number">3</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>相反，如果没有找到，会得到一个<code>404 Not Found</code>响应码</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;found&quot;</span> :    <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">&quot;_index&quot;</span> :   <span class="string">&quot;website&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;_type&quot;</span> :    <span class="string">&quot;blog&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;_id&quot;</span> :      <span class="string">&quot;123&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;_version&quot;</span> : <span class="number">4</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果文档不存在，_version的值也会增加</p>
<h3 id="处理冲突"><a href="#处理冲突" class="headerlink" title="处理冲突"></a>处理冲突</h3><p>好了，这时候我们已经看完了对es文档简单的增删查改</p>
<p>现在，设想这样一种情况：</p>
<ul>
<li>当我们使用API去更新整个ES文档时，这时候有人对这个文档进行了修改，那么他的修改将会丢失</li>
</ul>
<p>在某些情况中，这种冲突会变得非常严重，而在数据库领域中，我们一般会有两种方式来确保这种事情不会发生：</p>
<ul>
<li>悲观锁</li>
<li>乐观锁</li>
</ul>
<h4 id="悲观锁"><a href="#悲观锁" class="headerlink" title="悲观锁"></a>悲观锁</h4><p>这种方式在数据库中被广泛应用，它假设变更冲突可能发生，于是就阻塞访问资源，以此来防止冲突的发生。</p>
<p>例子：在读取一行数据之前将数据上锁，确保只有放置所的线程能够对这行数据进行修改</p>
<h4 id="乐观锁"><a href="#乐观锁" class="headerlink" title="乐观锁"></a>乐观锁</h4><p>ES中使用的正是这种锁，它假设冲突不会发生，所以并不会阻塞操作。</p>
<p><strong>但是</strong>，如果数据在读写过程中被修改了，更新将会失败。</p>
<h3 id="乐观并发控制"><a href="#乐观并发控制" class="headerlink" title="乐观并发控制"></a>乐观并发控制</h3><p>在ES底层使用的是CAS机制，详细可以看我的另一篇博客《原子类》，其中有介绍CAS机制的原理。</p>
<p>在这里做一个简单地介绍：</p>
<p>在ES中有一个字段<code>_version</code>，用来记录当前文档版本。</p>
<p>现在创建一个新的文档</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PUT /website/blog/<span class="number">1</span>/_create</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;My first blog entry&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;text&quot;</span>:  <span class="string">&quot;Just trying this out...&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>响应体会告诉我们，当前创建的这个文档版本号<code>_version</code>为1，现在我们对它做一些修改</p>
<p>先检索该文档</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /website/blog/<span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>响应体：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;_index&quot;</span> :   <span class="string">&quot;website&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;_type&quot;</span> :    <span class="string">&quot;blog&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;_id&quot;</span> :      <span class="string">&quot;1&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;_version&quot;</span> : <span class="number">1</span>,</span><br><span class="line">  <span class="attr">&quot;found&quot;</span> :    <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">&quot;_source&quot;</span> :  &#123;</span><br><span class="line">      <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;My first blog entry&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;text&quot;</span>:  <span class="string">&quot;Just trying this out...&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>更新文档数据</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PUT /website/blog/<span class="number">1</span>?version=<span class="number">1</span> </span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;My first blog entry&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;text&quot;</span>:  <span class="string">&quot;Starting to get the hang of this...&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里带了个version参数，也就是说，只有当前<code>_version</code>为1时，本次更新才能成功</p>
<p>除此之外，我们还可以通过外部系统使用版本控制</p>
<h4 id="通过外部系统使用版本控制"><a href="#通过外部系统使用版本控制" class="headerlink" title="通过外部系统使用版本控制"></a>通过外部系统使用版本控制</h4><p>或许我们会把其他数据库作为主要的数据存储，而把ES作为数据检索，这意味着我们需要把主数据库的修改都复制到ES，如果多个进程负责这一数据同步，你可能会遇到类似于之前那样的并发问题。</p>
<p>如果你的主数据库已经有了版本号或者一个能作为版本号的字段值，那么就可以在ES中通过增加<code>version_type=external</code>到查询字符串的方式重用这些版本号</p>
<p>注意：版本号需要时大于0的整数，并且小于9.2E+18的一个值</p>
<p>而ES对于这次版本号的查询也和之前不一样，之前处理版本号时，ES会检查当前<code>_version</code>和请求中指定的版本号是否相同，而这次是检查是否小于指定版本号。</p>
<p>案例：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PUT /website/blog/<span class="number">2</span>?version=<span class="number">5</span>&amp;version_type=external</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;My first external blog entry&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;text&quot;</span>:  <span class="string">&quot;Starting to get the hang of this...&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>响应结果：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;_index&quot;</span>:   <span class="string">&quot;website&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;_type&quot;</span>:    <span class="string">&quot;blog&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;_id&quot;</span>:      <span class="string">&quot;2&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;_version&quot;</span>: <span class="number">5</span>,</span><br><span class="line">  <span class="attr">&quot;created&quot;</span>:  <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们再来更新一下</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PUT /website/blog/<span class="number">2</span>?version=<span class="number">10</span>&amp;version_type=external</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;My first external blog entry&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;text&quot;</span>:  <span class="string">&quot;This is a piece of cake...&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>响应结果：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;_index&quot;</span>:   <span class="string">&quot;website&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;_type&quot;</span>:    <span class="string">&quot;blog&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;_id&quot;</span>:      <span class="string">&quot;2&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;_version&quot;</span>: <span class="number">10</span>,</span><br><span class="line">  <span class="attr">&quot;created&quot;</span>:  <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但是如果我们重新运行一遍版本号为10的请求，就会报错</p>
<h3 id="文档部分更新"><a href="#文档部分更新" class="headerlink" title="文档部分更新"></a>文档部分更新</h3><p>在之前我们已经知道了怎么更新整个文档：</p>
<ul>
<li>检索文档</li>
<li>修改文档</li>
<li>重新索引整个文档</li>
</ul>
<p>使用UPDATE API 我们可以对部分文档进行更新，但是还是需要遵循之前的规则：文档只能被替换，不能修改</p>
<p>案例：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">POST /website/blog/<span class="number">1</span>/_update</span><br><span class="line">&#123;</span><br><span class="line">   <span class="attr">&quot;doc&quot;</span> : &#123;</span><br><span class="line">      <span class="attr">&quot;tags&quot;</span> : [ <span class="string">&quot;testing&quot;</span> ],</span><br><span class="line">      <span class="attr">&quot;views&quot;</span>: <span class="number">0</span></span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果请求成功，我们可以看到</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   <span class="attr">&quot;_index&quot;</span> :   <span class="string">&quot;website&quot;</span>,</span><br><span class="line">   <span class="attr">&quot;_id&quot;</span> :      <span class="string">&quot;1&quot;</span>,</span><br><span class="line">   <span class="attr">&quot;_type&quot;</span> :    <span class="string">&quot;blog&quot;</span>,</span><br><span class="line">   <span class="attr">&quot;_version&quot;</span> : <span class="number">3</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这时如果我们查询该文档</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   <span class="attr">&quot;_index&quot;</span>:    <span class="string">&quot;website&quot;</span>,</span><br><span class="line">   <span class="attr">&quot;_type&quot;</span>:     <span class="string">&quot;blog&quot;</span>,</span><br><span class="line">   <span class="attr">&quot;_id&quot;</span>:       <span class="string">&quot;1&quot;</span>,</span><br><span class="line">   <span class="attr">&quot;_version&quot;</span>:  <span class="number">3</span>,</span><br><span class="line">   <span class="attr">&quot;found&quot;</span>:     <span class="literal">true</span>,</span><br><span class="line">   <span class="attr">&quot;_source&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;title&quot;</span>:  <span class="string">&quot;My first blog entry&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;text&quot;</span>:   <span class="string">&quot;Starting to get the hang of this...&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;tags&quot;</span>: [ <span class="string">&quot;testing&quot;</span> ], </span><br><span class="line">      <span class="attr">&quot;views&quot;</span>:  <span class="number">0</span> </span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>新的字段已经加进去了</p>
<p>我们也可以使用脚本来更新</p>
<h4 id="使用脚本更新文档"><a href="#使用脚本更新文档" class="headerlink" title="使用脚本更新文档"></a>使用脚本更新文档</h4><p>脚本可以在UPDATE API中用来改变<code>_source</code>中的字段内容，他在更新脚本中成为<code>ctx._source</code>。</p>
<p>例如，如果我们想要使用脚本来增加文档中views的数量</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">POST /website/blog/<span class="number">1</span>/_update</span><br><span class="line">&#123;</span><br><span class="line">   <span class="attr">&quot;script&quot;</span> : <span class="string">&quot;ctx._source.views+=1&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>或者想给tag中新加一个标签：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">POST /website/blog/<span class="number">1</span>/_update</span><br><span class="line">&#123;</span><br><span class="line">   <span class="attr">&quot;script&quot;</span> : <span class="string">&quot;ctx._source.tags+=new_tag&quot;</span>,</span><br><span class="line">   <span class="attr">&quot;params&quot;</span> : &#123;</span><br><span class="line">      <span class="attr">&quot;new_tag&quot;</span> : <span class="string">&quot;search&quot;</span></span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结果：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   <span class="attr">&quot;_index&quot;</span>:    <span class="string">&quot;website&quot;</span>,</span><br><span class="line">   <span class="attr">&quot;_type&quot;</span>:     <span class="string">&quot;blog&quot;</span>,</span><br><span class="line">   <span class="attr">&quot;_id&quot;</span>:       <span class="string">&quot;1&quot;</span>,</span><br><span class="line">   <span class="attr">&quot;_version&quot;</span>:  <span class="number">5</span>,</span><br><span class="line">   <span class="attr">&quot;found&quot;</span>:     <span class="literal">true</span>,</span><br><span class="line">   <span class="attr">&quot;_source&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;title&quot;</span>:  <span class="string">&quot;My first blog entry&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;text&quot;</span>:   <span class="string">&quot;Starting to get the hang of this...&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;tags&quot;</span>:  [<span class="string">&quot;testing&quot;</span>, <span class="string">&quot;search&quot;</span>], </span><br><span class="line">      <span class="attr">&quot;views&quot;</span>:  <span class="number">1</span> </span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="更新的文档可能上不存在"><a href="#更新的文档可能上不存在" class="headerlink" title="更新的文档可能上不存在"></a>更新的文档可能上不存在</h4><p>提需求了提需求了：现在要在ES里加入一个页面访问量计数器，当有人浏览页面时，对该页面的计数器进行累加，但是有些网页是新网页，你也不知道这个计数器存不存在。</p>
<p>在这种情况下，我们可以使用<code>upsert</code>参数，如果文档不存在，就先创建它：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">POST /website/pageviews/<span class="number">1</span>/_update</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;script&quot;</span>: <span class="string">&quot;ctx._source.views+=1&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;upsert&quot;</span>:&#123;</span><br><span class="line">        <span class="attr">&quot;views&quot;</span>:<span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="更新和冲突"><a href="#更新和冲突" class="headerlink" title="更新和冲突"></a>更新和冲突</h4><p>乐观锁并不能完全消除冲突的可能性，version改变导致更新失败，遇到这种情况，我们只需要尝试再次更新。</p>
<p>这可以通过参数<code>retry_on_conflict</code>来自动完成，这个参数规定了失败之前<code>update</code>应该重试的次数，默认值为0</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">POST /website/pageviews/<span class="number">1</span>/_update?retry_on_conflict=<span class="number">5</span> </span><br><span class="line">&#123;</span><br><span class="line">   <span class="attr">&quot;script&quot;</span> : <span class="string">&quot;ctx._source.views+=1&quot;</span>,</span><br><span class="line">   <span class="attr">&quot;upsert&quot;</span>: &#123;</span><br><span class="line">       <span class="attr">&quot;views&quot;</span>: <span class="number">0</span></span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个就表示如果更新失败了至多会重试5次。</p>
<h3 id="取回多个文档"><a href="#取回多个文档" class="headerlink" title="取回多个文档"></a>取回多个文档</h3><p>ES速度很快，但是还可以更快，我们可以吧多个请求合并成一个，避免单独处理每个请求产生的网络延迟和开销。如果需要检索很多文档，可以使用<code>multiget</code>或者<code>mget</code>API来讲这些请求放再同一个请求中。</p>
<h4 id="megt"><a href="#megt" class="headerlink" title="megt"></a>megt</h4><p>mgetAPI参数要求：</p>
<ul>
<li>docs</li>
</ul>
<p>需要有一个docs数组作为参数，其中每个元素都要有检索文档包含的元数据</p>
<p>例子：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">GET /_mget</span><br><span class="line">&#123;</span><br><span class="line">   <span class="attr">&quot;docs&quot;</span> : [</span><br><span class="line">      &#123;</span><br><span class="line">         <span class="attr">&quot;_index&quot;</span> : <span class="string">&quot;website&quot;</span>,</span><br><span class="line">         <span class="attr">&quot;_type&quot;</span> :  <span class="string">&quot;blog&quot;</span>,</span><br><span class="line">         <span class="attr">&quot;_id&quot;</span> :    <span class="number">2</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">         <span class="attr">&quot;_index&quot;</span> : <span class="string">&quot;website&quot;</span>,</span><br><span class="line">         <span class="attr">&quot;_type&quot;</span> :  <span class="string">&quot;pageviews&quot;</span>,</span><br><span class="line">         <span class="attr">&quot;_id&quot;</span> :    <span class="number">1</span>,</span><br><span class="line">         <span class="attr">&quot;_source&quot;</span>: <span class="string">&quot;views&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">   ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>响应体也含有一个docs数组：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   <span class="attr">&quot;docs&quot;</span> : [</span><br><span class="line">      &#123;</span><br><span class="line">         <span class="attr">&quot;_index&quot;</span> :   <span class="string">&quot;website&quot;</span>,</span><br><span class="line">         <span class="attr">&quot;_id&quot;</span> :      <span class="string">&quot;2&quot;</span>,</span><br><span class="line">         <span class="attr">&quot;_type&quot;</span> :    <span class="string">&quot;blog&quot;</span>,</span><br><span class="line">         <span class="attr">&quot;found&quot;</span> :    <span class="literal">true</span>,</span><br><span class="line">         <span class="attr">&quot;_source&quot;</span> : &#123;</span><br><span class="line">            <span class="attr">&quot;text&quot;</span> :  <span class="string">&quot;This is a piece of cake...&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;title&quot;</span> : <span class="string">&quot;My first external blog entry&quot;</span></span><br><span class="line">         &#125;,</span><br><span class="line">         <span class="attr">&quot;_version&quot;</span> : <span class="number">10</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">         <span class="attr">&quot;_index&quot;</span> :   <span class="string">&quot;website&quot;</span>,</span><br><span class="line">         <span class="attr">&quot;_id&quot;</span> :      <span class="string">&quot;1&quot;</span>,</span><br><span class="line">         <span class="attr">&quot;_type&quot;</span> :    <span class="string">&quot;pageviews&quot;</span>,</span><br><span class="line">         <span class="attr">&quot;found&quot;</span> :    <span class="literal">true</span>,</span><br><span class="line">         <span class="attr">&quot;_version&quot;</span> : <span class="number">2</span>,</span><br><span class="line">         <span class="attr">&quot;_source&quot;</span> : &#123;</span><br><span class="line">            <span class="attr">&quot;views&quot;</span> : <span class="number">2</span></span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">   ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用mget的另一个姿势</p>
<p>如果检索的数据都属于同一个<code>index</code>和<code>type</code>，可以将<code>index</code></p>
<p>和<code>type</code>放在url中，不用重复去写，当然，如果想在这里面访问其他index，也可以写在<code>docs</code>中进行覆盖</p>
<p>案例：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">GET /website/blog/_mget</span><br><span class="line">&#123;</span><br><span class="line">   <span class="attr">&quot;docs&quot;</span> : [</span><br><span class="line">      &#123; <span class="attr">&quot;_id&quot;</span> : <span class="number">2</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">&quot;_type&quot;</span> : <span class="string">&quot;pageviews&quot;</span>, <span class="attr">&quot;_id&quot;</span> :   <span class="number">1</span> &#125;</span><br><span class="line">   ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果所有<code>index</code>和<code>type</code>都是相同的，你还可以这么写</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">GET /website/blog/_mget</span><br><span class="line">&#123;</span><br><span class="line">   <span class="attr">&quot;ids&quot;</span> : [ <span class="string">&quot;2&quot;</span>, <span class="string">&quot;1&quot;</span> ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这甚至不需要写<code>docs</code></p>
<p>当然，他们之间的查询是相互独立的，一次查询出现的错误并不会影响所有</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;docs&quot;</span> : [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;_index&quot;</span> :   <span class="string">&quot;website&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;_type&quot;</span> :    <span class="string">&quot;blog&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;_id&quot;</span> :      <span class="string">&quot;2&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;_version&quot;</span> : <span class="number">10</span>,</span><br><span class="line">      <span class="attr">&quot;found&quot;</span> :    <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">&quot;_source&quot;</span> : &#123;</span><br><span class="line">        <span class="attr">&quot;title&quot;</span>:   <span class="string">&quot;My first external blog entry&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;text&quot;</span>:    <span class="string">&quot;This is a piece of cake...&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;_index&quot;</span> :   <span class="string">&quot;website&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;_type&quot;</span> :    <span class="string">&quot;blog&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;_id&quot;</span> :      <span class="string">&quot;1&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;found&quot;</span> :    <span class="literal">false</span>  </span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="代价较小的批量操作"><a href="#代价较小的批量操作" class="headerlink" title="代价较小的批量操作"></a>代价较小的批量操作</h3><p>看完了<code>mget</code>，是不是觉得挺方便，如果不同的请求也能放在同一次操作里执行不就起飞了，ES有一个<code>bulk</code>API专门用来干这事</p>
<p>来看一看</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123; action: &#123; metadata &#125;&#125;\n</span><br><span class="line">&#123; request body        &#125;\n</span><br><span class="line">&#123; action: &#123; metadata &#125;&#125;\n</span><br><span class="line">&#123; request body        &#125;\n</span><br></pre></td></tr></table></figure>

<p>注意：每行一定要以<code>\n</code>结尾，<strong>包括最后一行</strong></p>
<p>为什么要规定这种格式，为什么不能和<code>mget</code>一样将参数包装在一个json数组中：</p>
<ul>
<li>为了解释这点我们需要了解一些东西：在批量请求中，每个文档可能属于不同的主分片，可能被分配给集群中的任意节点，这意味着<code>bulk</code>请求中的所有操作都需要被转发到正确节点上的正确分片</li>
<li>如果请求被包含在json数组中，就意味着我们需要做以下操作<ul>
<li>将JSON解析为数组（包括数据，可以非常大）</li>
<li>查看每个请求应该发送到哪个分片</li>
<li>为每个分片创建一个请求数组</li>
<li>为这些数字序列化为内部传输格式</li>
<li>将请求发送到每个分片</li>
</ul>
</li>
<li>这行为虽然可行，但是需要大量内存来存储原本相同的数据的副本，并创建更多的数据结构，JVM需要用更多的时间进行垃圾回收</li>
<li>相反，ES可以直接读取被网络缓冲区接收的原始数据，它使用换行符来识别和解析每一个小的请求，并进行处理，没有冗余的数据复制，没有浪费的数据结构，整个请求尽可能在最小的内存中处理</li>
</ul>
<p>在这里有新的参数<code>action</code>和<code>request body</code></p>
<p><code>action/metadata</code>参数指定了我们要对哪一个文档做什么操作，并且必须是一下选项之一：</p>
<ul>
<li>create：如果文档不存在，就创建它</li>
<li>index：创建一个新文档或者更新文档</li>
<li>update：部分更新文档</li>
<li>delete：删除文档</li>
</ul>
<p>并且这个参数应该指定被操作文档的<code>index</code>、<code>id</code>、<code>type</code></p>
<p>例子：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">&quot;delete&quot;</span>: &#123;<span class="attr">&quot;_index&quot;</span>: <span class="string">&quot;website&quot;</span>,<span class="attr">&quot;_type&quot;</span>: <span class="string">&quot;blog&quot;</span>,<span class="attr">&quot;_id&quot;</span>: <span class="string">&quot;123&quot;</span>&#125;&#125;</span><br></pre></td></tr></table></figure>

<p><code>action</code>介绍完了，来介绍一下<code>request body</code></p>
<p>这个字段包含文档中的数据，是<code>update</code>操作必须的，并且和<code>update</code>API一样，你应该传递<code>doc</code>、<code>upsert</code>、<code>script</code>这些数据</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123; <span class="attr">&quot;create&quot;</span>:  &#123; <span class="attr">&quot;_index&quot;</span>: <span class="string">&quot;website&quot;</span>, <span class="attr">&quot;_type&quot;</span>: <span class="string">&quot;blog&quot;</span>, <span class="attr">&quot;_id&quot;</span>: <span class="string">&quot;123&quot;</span> &#125;&#125;</span><br><span class="line">&#123; <span class="attr">&quot;title&quot;</span>:    <span class="string">&quot;My first blog post&quot;</span> &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123; <span class="attr">&quot;index&quot;</span>: &#123; <span class="attr">&quot;_index&quot;</span>: <span class="string">&quot;website&quot;</span>, <span class="attr">&quot;_type&quot;</span>: <span class="string">&quot;blog&quot;</span> &#125;&#125;</span><br><span class="line">&#123; <span class="attr">&quot;title&quot;</span>:    <span class="string">&quot;My second blog post&quot;</span> &#125;</span><br></pre></td></tr></table></figure>

<p>与<code>index</code>API相同，如果你不指定ID，ES会自动生成一个</p>
<p>完整的<code>bulk</code>请求如下</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">POST /_bulk</span><br><span class="line">&#123; <span class="attr">&quot;delete&quot;</span>: &#123; <span class="attr">&quot;_index&quot;</span>: <span class="string">&quot;website&quot;</span>, <span class="attr">&quot;_type&quot;</span>: <span class="string">&quot;blog&quot;</span>, <span class="attr">&quot;_id&quot;</span>: <span class="string">&quot;123&quot;</span> &#125;&#125; </span><br><span class="line">&#123; <span class="attr">&quot;create&quot;</span>: &#123; <span class="attr">&quot;_index&quot;</span>: <span class="string">&quot;website&quot;</span>, <span class="attr">&quot;_type&quot;</span>: <span class="string">&quot;blog&quot;</span>, <span class="attr">&quot;_id&quot;</span>: <span class="string">&quot;123&quot;</span> &#125;&#125;</span><br><span class="line">&#123; <span class="attr">&quot;title&quot;</span>:    <span class="string">&quot;My first blog post&quot;</span> &#125;</span><br><span class="line">&#123; <span class="attr">&quot;index&quot;</span>:  &#123; <span class="attr">&quot;_index&quot;</span>: <span class="string">&quot;website&quot;</span>, <span class="attr">&quot;_type&quot;</span>: <span class="string">&quot;blog&quot;</span> &#125;&#125;</span><br><span class="line">&#123; <span class="attr">&quot;title&quot;</span>:    <span class="string">&quot;My second blog post&quot;</span> &#125;</span><br><span class="line">&#123; <span class="attr">&quot;update&quot;</span>: &#123; <span class="attr">&quot;_index&quot;</span>: <span class="string">&quot;website&quot;</span>, <span class="attr">&quot;_type&quot;</span>: <span class="string">&quot;blog&quot;</span>, <span class="attr">&quot;_id&quot;</span>: <span class="string">&quot;123&quot;</span>, <span class="attr">&quot;_retry_on_conflict&quot;</span> : <span class="number">3</span>&#125; &#125;</span><br><span class="line">&#123; <span class="attr">&quot;doc&quot;</span> : &#123;<span class="attr">&quot;title&quot;</span> : <span class="string">&quot;My updated blog post&quot;</span>&#125; &#125;</span><br></pre></td></tr></table></figure>

<p>响应体：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   <span class="attr">&quot;took&quot;</span>: <span class="number">4</span>,</span><br><span class="line">   <span class="attr">&quot;errors&quot;</span>: <span class="literal">false</span>, </span><br><span class="line">   <span class="attr">&quot;items&quot;</span>: [</span><br><span class="line">      &#123;  <span class="attr">&quot;delete&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;_index&quot;</span>:   <span class="string">&quot;website&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;_type&quot;</span>:    <span class="string">&quot;blog&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;_id&quot;</span>:      <span class="string">&quot;123&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;_version&quot;</span>: <span class="number">2</span>,</span><br><span class="line">            <span class="attr">&quot;status&quot;</span>:   <span class="number">200</span>,</span><br><span class="line">            <span class="attr">&quot;found&quot;</span>:    <span class="literal">true</span></span><br><span class="line">      &#125;&#125;,</span><br><span class="line">      &#123;  <span class="attr">&quot;create&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;_index&quot;</span>:   <span class="string">&quot;website&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;_type&quot;</span>:    <span class="string">&quot;blog&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;_id&quot;</span>:      <span class="string">&quot;123&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;_version&quot;</span>: <span class="number">3</span>,</span><br><span class="line">            <span class="attr">&quot;status&quot;</span>:   <span class="number">201</span></span><br><span class="line">      &#125;&#125;,</span><br><span class="line">      &#123;  <span class="attr">&quot;create&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;_index&quot;</span>:   <span class="string">&quot;website&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;_type&quot;</span>:    <span class="string">&quot;blog&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;_id&quot;</span>:      <span class="string">&quot;EiwfApScQiiy7TIKFxRCTw&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;_version&quot;</span>: <span class="number">1</span>,</span><br><span class="line">            <span class="attr">&quot;status&quot;</span>:   <span class="number">201</span></span><br><span class="line">      &#125;&#125;,</span><br><span class="line">      &#123;  <span class="attr">&quot;update&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;_index&quot;</span>:   <span class="string">&quot;website&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;_type&quot;</span>:    <span class="string">&quot;blog&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;_id&quot;</span>:      <span class="string">&quot;123&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;_version&quot;</span>: <span class="number">4</span>,</span><br><span class="line">            <span class="attr">&quot;status&quot;</span>:   <span class="number">200</span></span><br><span class="line">      &#125;&#125;</span><br><span class="line">   ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><del>新的属性又跳出来给了你一个耳刮子（不是）</del></p>
<p>又有新的属性了，一起看看</p>
<ul>
<li>took：这次的请求花费了多少<strong>毫秒</strong></li>
<li>errors：有没有失败的子请求，如果为false就是请求全部成功</li>
<li>items：按照请求的顺序列出的响应结果</li>
</ul>
<p>和刚才的<code>mget</code>API相同，每个子请求都独立执行，一次失败并不会影响整体</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   <span class="attr">&quot;took&quot;</span>: <span class="number">3</span>,</span><br><span class="line">   <span class="attr">&quot;errors&quot;</span>: <span class="literal">true</span>, </span><br><span class="line">   <span class="attr">&quot;items&quot;</span>: [</span><br><span class="line">      &#123;  <span class="attr">&quot;create&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;_index&quot;</span>:   <span class="string">&quot;website&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;_type&quot;</span>:    <span class="string">&quot;blog&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;_id&quot;</span>:      <span class="string">&quot;123&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;status&quot;</span>:   <span class="number">409</span>, </span><br><span class="line">            <span class="attr">&quot;error&quot;</span>:    <span class="string">&quot;DocumentAlreadyExistsException </span></span><br><span class="line"><span class="string">                        [[website][4] [blog][123]:</span></span><br><span class="line"><span class="string">                        document already exists]&quot;</span></span><br><span class="line">      &#125;&#125;,</span><br><span class="line">      &#123;  <span class="attr">&quot;index&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;_index&quot;</span>:   <span class="string">&quot;website&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;_type&quot;</span>:    <span class="string">&quot;blog&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;_id&quot;</span>:      <span class="string">&quot;123&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;_version&quot;</span>: <span class="number">5</span>,</span><br><span class="line">            <span class="attr">&quot;status&quot;</span>:   <span class="number">200</span> </span><br><span class="line">      &#125;&#125;</span><br><span class="line">   ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>比如这个响应体，<code>create</code>请求失败了，但是<code>index</code>请求成功了，这种方式虽然好，但是有个缺点：</p>
<ul>
<li>每个请求之间独立处理，这也意味着<code>bulk</code>请求并非原子性的，无法实现事务控制</li>
</ul>
<p>批量请求能帮助我们加快查询速度，但是这个加快也是有限制的，并不是数据量越大节省的时间越多，当我们批量请求时，所有的请求都要由接收到的节点加载到内存中，因此请求越大，其它请求所能获得的内存就越少。</p>
<p>批量请求的大小有一个最佳值，它取决于硬件大小，文档大小和复杂度、索引和搜索的负载的整体情况，有点复杂，怎么找到这个最佳点，一个简单地方法就是疯狂测试。</p>
<h2 id="分布式文档存储"><a href="#分布式文档存储" class="headerlink" title="分布式文档存储"></a>分布式文档存储</h2><p>前面我们了解了ES数据的存取，都是一些操作性的东西，没有什么技术含量，来点有技术的东西吧。</p>
<p>在这章中，我们会介绍文件是如何分布到集群的，又是如何从集群中获取等核心的技术细节，这能帮助我们更好的理解ES，当然，如果你不想这么深入了解，也并没有什么太大问题，也能正常使用。</p>
<h3 id="路由一个文档到一个分片中"><a href="#路由一个文档到一个分片中" class="headerlink" title="路由一个文档到一个分片中"></a>路由一个文档到一个分片中</h3><p>我们知道，在ES中，一个节点可以有多个分片，那我们又怎么知道文档是被存放到哪一个分片中的呢？</p>
<p>实际上，ES对这个有一套公式</p>
<p><code>shard = hash(routing) % number_of_primary_shards</code></p>
<p><del>看不懂吗，看不懂没关系，我也看不懂</del></p>
<p>首先，<code>routing</code>是一个可变值，默认为文档的<code>id</code>，也可以设置成一个自定义的值，<code>routing</code>通过hash函数生成一个数字，根据这个数字来决定这个文档会被存放到哪一个分片中去</p>
<p>同时，这也解释了为什么我们创建索引的时候就要确定好主分片的数量，并且永远不能改变这个数量，如果数量可以改变，那么之前的路由也就全都无效了，会导致文档丢失</p>
<p>继续说回<code>routing</code>，前面说我们可以自定义routing的值，怎么定义呢，所有文档的API（<code>get</code>、<code>index</code>、<code>delete</code>、<code>bulk</code>、<code>update</code>、<code>mget</code>）都可以接受一个<code>routing</code>参数，通过这个参数我们可以自动以文档到分片的映射。</p>
<p>这个有什么用呢？例如我们想要将所有属于同一个用户的文档都存储到某一个分片中，就可以这么设计，这个后面会讲到。</p>
<h3 id="主分片和副本分片的交互"><a href="#主分片和副本分片的交互" class="headerlink" title="主分片和副本分片的交互"></a>主分片和副本分片的交互</h3><p>假设我们现在有一个ES集群，在这个集群中有三个节点。他们包含了一个叫做<code>blogs</code>的索引，有两个主分片，每一个主分片又有两个副本分片。相同分片的副本不会放在同一个节点中，所以我们的节点应该是这样子</p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">节点1（master）	节点2		   节点3</span><br><span class="line"> R0   P1       R0    R1      P0   R1</span><br></pre></td></tr></table></figure>

<p>P代表主分片，R代表副分片</p>
<p>在这个集群中，每一个节点都有处理任意请求的能力，每个节点都知道集群中任意文档的位置，可以直接将请求转发到需要的分片上。</p>
<h3 id="新建、索引和删除文档"><a href="#新建、索引和删除文档" class="headerlink" title="新建、索引和删除文档"></a>新建、索引和删除文档</h3><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">这章可能文字比较多，但是不难，耐心看完</span><br></pre></td></tr></table></figure>

<p>为什么叫副本分片，因为它本身只能用来进行读操作，那么它如何进行写操作呢，如同新建、索引和删除文档的请求都是写操作，必须在主分片上完成之后再复制到副本分片上</p>
<p>如果副本分片接收到了写操作，该分片所属节点会将请求发送到主分片所属节点</p>
<p>比如，如果我们将想要更新<code>P1</code>分片下的文档，但是这个请求被发送到了节点2上，那么ES将会进行如下操作：</p>
<ul>
<li>根据节点使用文档的<code>id</code>确定文档属于分片1，这时请求会被转发到节点1上</li>
<li>节点1根据请求进行相应操作，如果操作成功，它会将请求并行转发到节点2和节点3的副本分片上进行赋值。</li>
<li>如果所有副本分片都报告复制成功，节点1将会返回请求成功的信息。</li>
</ul>
<p>在文档变更时，所有主分片和副分片都执行完成时才是执行成功的，因此数据安全</p>
<p>但是有一些可选的参数请求允许我们以安全作为代价来提升性能，<strong>并不推荐这么做</strong>，因为ES已经很快了：</p>
<h4 id="consistency"><a href="#consistency" class="headerlink" title="consistency"></a>consistency</h4><p>consistency，翻译：一致性，在默认设置下，为了避免网络分区故障导致的数据不一致，如果想要对分片进行写操作，主分片会检测所有副本分片是否处于活跃状态，如果全部处于活跃状态，才会去进行写操作。</p>
<p>参数值：</p>
<ul>
<li>one：只要主分片状态OK就可以进行写操作</li>
<li>all：只有主分片和所有副本分片状态OK才能进行写操作</li>
<li>quorum：大多数副本分片状态OK就可以进行写操作</li>
</ul>
<p>怎么算大多数呢，ES对此有一个计算公式：</p>
<p><code>int((primary + replicas) / 2) + 1</code></p>
<p>primary：主分片数量</p>
<p>replicas：副本分片数量</p>
<p>也就是说，在本案例中，当所有活跃分配总和大于等于<code>(1 + 3) / 2 + 1 = 3</code>时，就可以进行写操作。</p>
<h4 id="timeout"><a href="#timeout" class="headerlink" title="timeout"></a>timeout</h4><p>当进行写操作时，如果没有足够的副本分片，ES不会立即返回错误，而是会等待一段时间，默认情况下ES最多会等待一分钟，而<code>timeout</code>参数可以设置等待时间，<code>100</code>代表100毫秒，<code>30s</code>代表30秒</p>
<h3 id="取回一个文档-1"><a href="#取回一个文档-1" class="headerlink" title="取回一个文档"></a>取回一个文档</h3><p>我们可以从ES集群中的主分片或者其他任意副本分片检索文档，步骤如下：</p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">节点1（master）	节点2		   节点3</span><br><span class="line"> R0   P1       R0    R1      P0   R1</span><br></pre></td></tr></table></figure>

<p>同样还是这一个集群</p>
<ul>
<li>客户端向节点1发送了一个<code>get</code>请求</li>
<li>节点通过文档的<code>id</code>确认了该文档属于分片0，分片0在三个节点上都有分片，在这种情况下，节点1会随机将请求转发或者在当前节点获取，这里假设请求转发给了节点2</li>
<li>节点2将文档返回给节点1，然后节点1再将文档返回给客户</li>
</ul>
<p>在ES集群中处理请求时，协调节点在每次请求的时候都会通过轮询所有的副本分片来达到负载均衡。</p>
<h3 id="局部更新文档"><a href="#局部更新文档" class="headerlink" title="局部更新文档"></a>局部更新文档</h3><p>在ES集群中，更新文档的步骤会比前两个多一些，还是拿这个集群做演示</p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">节点1（master）	节点2		   节点3</span><br><span class="line"> R0   P1       R0    R1      P0   R1</span><br></pre></td></tr></table></figure>

<ul>
<li>客户端向节点1发送了一个<code>update</code>请求</li>
<li>节点1检测到该文档属于分片0，于是会将请求转发到节点3上</li>
<li>节点3从主分片索引文档，修改<code>_source</code>字段中的json，并且尝试重新索引文档（至于为什么要重新索引，回去看<code>update</code>请求的原理）。如果文档已经被另一个进程修改，节点会重复这一步骤，如果超时才放弃。</li>
<li>如果节点3更新文档成功了，那么他会将新的文档并行转发至节点1和节点2的副本分片，重新建立索引，如果都更新成功了，节点3会向协调节点返回成功，协调节点向客户端返回成功</li>
</ul>
<h3 id="多文档模式"><a href="#多文档模式" class="headerlink" title="多文档模式"></a>多文档模式</h3><p><code>mget</code>和<code>bulk</code>API的模式<strong>类似于</strong>单文档模式，但是又有所不同：</p>
<ul>
<li>协调节点知道每个文档在哪个分片中。它会将多文档请求分解成每个分片的多文档请求，并且将这些请求转发到对应的节点</li>
</ul>
<p>使用<code>mget</code>步骤如下：</p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">节点1（master）	节点2		   节点3</span><br><span class="line"> R0   P1       R0    R1      P0   R1</span><br></pre></td></tr></table></figure>

<ul>
<li>客户端向节点1发送一个<code>mget</code>请求</li>
<li>节点1为每个分片构建多文档获取请求，然后并行转发到托管在每个所需的主分片或者副本分片的节点上。</li>
<li>被转发节点处理请求并返回结果，节点1收到所有请求后，会构建响应信息并返回给客户端</li>
</ul>
<p>在<code>mget</code>请求中可以在<code>docs</code>参数中为每个文档设置<code>routing</code>参数</p>
<p>使用<code>bulk</code>修改多个文档的步骤：</p>
<p>同样还是上面那个ES集群</p>
<ul>
<li>客户端向节点1发送一个<code>bulk</code>请求</li>
<li>节点1根据文档<code>id</code>创建批量请求，并将请求发送到包含对应主分片的节点上</li>
<li>主分片按照顺序执行请求，当一次操作成功后，主分片并行转发新文档到副本分片，然后执行下一个操作。当所有操作成功后，该节点向协调节点报告成功，协调节点向客户端返回结果</li>
</ul>
<p><code>bulk</code>API可以在整个批量请求的最顶层使用<code>consistency</code>参数，以及在每个请求的元数据中设置<code>routing</code>参数</p>
<h2 id="最基本的工具——搜索"><a href="#最基本的工具——搜索" class="headerlink" title="最基本的工具——搜索"></a>最基本的工具——搜索</h2><p>通过之前的学习，我们已经知道了ES简单操作的基本原理，以及如何使用ES作为NoSQL风格的分布式文档存储系统。但是，ES真正的强大之处并不在这里，在于它可以从无规律的数据中心找出有用的数据——从”大数据”到”大信息”</p>
<p>ES不仅仅能存储文档，还能够进行搜索，这也是为什么我们使用结构化的JSON文档，而不是无结构的二进制数据的原因。</p>
<p>在ES文档中，每一个字段都将被索引并且能够被查询，在简单的查询中，ES可以使用所有的索引字段，并且以极快的速度返回结果，ES搜索可以做到这些：</p>
<ul>
<li>在类似于<code>gender</code>或<code>age</code>这种字段上使用结构化查询，<code>join_date</code>这样的字段上可以使用排序，就像是SQL的结构化查询一样。</li>
<li>全文检索，找出所有匹配关键字的文档并按照相关性进行返回</li>
</ul>
<p>ES很多搜索都是开箱即用，为了方便我们充分挖掘ES的潜力，需要了解一下三个概念：</p>
<ul>
<li>映射（Mapping）：描述了数据在每个字段内如何存储</li>
<li>分析（Analysis）：全文是如何处理使之可以被搜索的</li>
<li>领域特定查询语言（Query DSL）：ES中强大而灵活的查询语言</li>
</ul>
<p>详细的内容我们会在后面讲到，在本章节，我们主要介绍这三点的一些基本概念</p>
<h3 id="空搜索"><a href="#空搜索" class="headerlink" title="空搜索"></a>空搜索</h3><p>在搜索API中，最基础的就是没有指定任何查询的空搜索，它会返回该集群中所有索引下的所有文档：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /_search</span><br></pre></td></tr></table></figure>

<p>响应体：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   <span class="attr">&quot;hits&quot;</span> : &#123;</span><br><span class="line">      <span class="attr">&quot;total&quot;</span> :       <span class="number">14</span>,</span><br><span class="line">      <span class="attr">&quot;hits&quot;</span> : [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;_index&quot;</span>:   <span class="string">&quot;us&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;_type&quot;</span>:    <span class="string">&quot;tweet&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;_id&quot;</span>:      <span class="string">&quot;7&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;_score&quot;</span>:   <span class="number">1</span>,</span><br><span class="line">          <span class="attr">&quot;_source&quot;</span>: &#123;</span><br><span class="line">             <span class="attr">&quot;date&quot;</span>:    <span class="string">&quot;2014-09-17&quot;</span>,</span><br><span class="line">             <span class="attr">&quot;name&quot;</span>:    <span class="string">&quot;John Smith&quot;</span>,</span><br><span class="line">             <span class="attr">&quot;tweet&quot;</span>:   <span class="string">&quot;The Query DSL is really powerful and flexible&quot;</span>,</span><br><span class="line">             <span class="attr">&quot;user_id&quot;</span>: <span class="number">2</span></span><br><span class="line">          &#125;</span><br><span class="line">       &#125;,</span><br><span class="line">        ... <span class="number">9</span> RESULTS REMOVED ...</span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">&quot;max_score&quot;</span> :   <span class="number">1</span></span><br><span class="line">   &#125;,</span><br><span class="line">   <span class="attr">&quot;took&quot;</span> :           <span class="number">4</span>,</span><br><span class="line">   <span class="attr">&quot;_shards&quot;</span> : &#123;</span><br><span class="line">      <span class="attr">&quot;failed&quot;</span> :      <span class="number">0</span>,</span><br><span class="line">      <span class="attr">&quot;successful&quot;</span> :  <span class="number">10</span>,</span><br><span class="line">      <span class="attr">&quot;total&quot;</span> :       <span class="number">10</span></span><br><span class="line">   &#125;,</span><br><span class="line">   <span class="attr">&quot;timed_out&quot;</span> :      <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>又有一些陌生的参数了，来看一看：</p>
<ul>
<li>hits<ul>
<li>这是返回结果中最重要的东西，它包含<code>total</code>字段和<code>hits</code>字段</li>
<li>total：匹配到的文档总数</li>
<li>hits：查询结果的前十个文档</li>
<li>在hits数组中，还有一个<code>score</code>参数，这个就是排序的依据</li>
<li>max_score：查询所匹配文档的<code>score</code>的最大值</li>
</ul>
</li>
<li>took：整个搜索请求耗费了多少毫秒</li>
<li>shards：在查询中参与分片的总数，以及这些分片成功了多少个，失败了多少个</li>
<li>timeout：查询多久超时</li>
</ul>
<h3 id="多索引、多类型"><a href="#多索引、多类型" class="headerlink" title="多索引、多类型"></a>多索引、多类型</h3><p>假设我们现在有两个索引：<code>us</code>和<code>gb</code>，如果不对某一特殊索引做限制，那么GET请求就会查询及群众的所有文档，ES会将请求转发到每一个主分片或者副本分片，汇集查询出的前十个结果，并且返回给我们</p>
<p>如果我们想在一个或者多个特定索引中进行搜索，可以通过在URL中指定索引和类型来达到这种效果：</p>
<ul>
<li><code>_search</code>：在所有索引中搜索所有的类型</li>
<li><code>/gb/_search</code>：在gb索引中搜索所有文档</li>
<li><code>/gb,us/_search</code>：在gb和us索引中搜索所有文档</li>
<li><code>/g*,u*/_search</code>：在所有g和u开头的索引中搜索所有文档</li>
<li><code>/gb/user/_search</code>：在gb索引中搜索user类型</li>
<li><code>/gb,us/user,tweet/_search</code>：在gb和us索引中搜索user和type类型</li>
<li><code>/_all/user,tweet/_search</code>：在所有索引中搜索user和type类型</li>
</ul>
<h3 id="分页"><a href="#分页" class="headerlink" title="分页"></a>分页</h3><p>在之前的搜索中，搜索出来的文档明明有14个，却只给我们展示了10条，那么如何能够看到后面的文档，和SQL中使用<code>limit</code>关键字返回单个<code>page</code>结果的方法相同，ES允许我们传入<code>from</code>和<code>size</code>参数</p>
<ul>
<li>size：返回的结果数量，默认为10</li>
<li>from：应该跳过的初始结果数量，默认为0</li>
</ul>
<p>也就是说，如果每页展示5条数据，通过下面这种方式，我们能获取1-3页的数据</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">GET /_search?size=<span class="number">5</span></span><br><span class="line">GET /_search?size=<span class="number">5</span>&amp;from=<span class="number">5</span></span><br><span class="line">GET /_search?size=<span class="number">5</span>&amp;from=<span class="number">10</span></span><br></pre></td></tr></table></figure>

<p>考虑到分页过深以及一次请求太多结果的情况，结果集在返回之前会先进行排序。<br>但是，一个请求常常会跨越多个分片，所以这些结果需要进行集中排序以保证整体顺序的一致。</p>
<h3 id="轻量搜索"><a href="#轻量搜索" class="headerlink" title="轻量搜索"></a>轻量搜索</h3><p>ES中有两种形式的搜索API：</p>
<ul>
<li>轻量的查询字符串版本，要求在查询字符串中传递所有的参数</li>
<li>更加完成的请求体版本，要求使用JSON格式和更丰富的查询表达式作为搜索语言</li>
</ul>
<h4 id="查询字符串搜索"><a href="#查询字符串搜索" class="headerlink" title="查询字符串搜索"></a>查询字符串搜索</h4><p>这种搜索非常适用于通过命令行做及时查询。</p>
<p>例如，如果想查询在<code>tweet</code>类型中<code>tweet</code>字段包含<code>elasticsearch</code>单词的所有文档，可以用下面这种方式：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /_all/tweet/_search?q=tweet:elasticsearch</span><br></pre></td></tr></table></figure>

<p>再比如，想在<code>name</code>字段中包含<code>john</code>并且在<code>tweet</code>字段中包含<code>mary</code>，实际查询就是</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">name:john+tweet:mary</span><br></pre></td></tr></table></figure>

<p>但是查询字符串参数需要<strong>百分比编码</strong>，这种编码会比较难以理解，这里用的是URL编码，可以去百度一下对应的值</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /_search?q=%<span class="number">2</span>Bname%<span class="number">3</span>Ajohn+%<span class="number">2</span>Btweet%<span class="number">3</span>Amary</span><br></pre></td></tr></table></figure>

<p>在这里，%2B代表<code>+</code>，%3A代表<code>:</code></p>
<p><code>+</code>前缀表示必须与查询条件匹配。</p>
<p><code>-</code>前缀表示一定不与查询条件匹配</p>
<h3 id="all字段"><a href="#all字段" class="headerlink" title="_all字段"></a>_all字段</h3><p>这个简单搜索返回包含<code>mary</code>的文档</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /_search?q=mary</span><br></pre></td></tr></table></figure>

<p>一下这些情况都会返回：</p>
<ul>
<li>有一个用户叫做<code>mary</code></li>
<li>六条微博发自<code>mary</code></li>
<li>一条微博<code>@mary</code></li>
</ul>
<p>虽然这三个值属于不同字段，但是都被ES查询出来了，那么ES是怎么做到的呢？</p>
<p>当我们索引一个文档的时候，ES会取出所有字段的值进行拼接，行程一个大的字符串，作为<code>_all</code>字段进行索引。例如，当索引这个文档时：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;tweet&quot;</span>:    <span class="string">&quot;However did I manage before Elasticsearch?&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;date&quot;</span>:     <span class="string">&quot;2014-09-14&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;name&quot;</span>:     <span class="string">&quot;Mary Jones&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;user_id&quot;</span>:  <span class="number">1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>就会变成</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;However did I manage before Elasticsearch? 2014-09-14 Mary Jones 1&quot;</span></span><br></pre></td></tr></table></figure>

<p>这就好像增加了一个<code>_all</code>额外字段</p>
<p>简单的查询并不能满足我们的需求，考虑下面这种条件：</p>
<ul>
<li><code>name</code>字段中包含<code>mary</code>或者<code>john</code></li>
<li><code>date</code>值大于<code>2014-09-10</code></li>
<li><code>_all</code>字段包括<code>aggregations</code>或者<code>geo</code></li>
</ul>
<p>伪代码：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">+name:(mary+john)+date:&gt;<span class="number">2014</span><span class="number">-09</span><span class="number">-10</span>+(aggregations geo)</span><br></pre></td></tr></table></figure>

<p>URL编码：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /_search?q=%<span class="number">2</span>Bname%<span class="number">3</span>A(mary+john)+%<span class="number">2</span>Bdate%<span class="number">3</span>A%<span class="number">3E2014</span><span class="number">-09</span><span class="number">-10</span>+%<span class="number">2</span>B(aggregations+geo)</span><br></pre></td></tr></table></figure>

<p>除了难以理解的URL编码，这种清凉的查询字符串搜索效果还是挺不错的。它的查询语法URL编码中有详细解释。</p>
<p>查询字符串搜索允许任何用户在索引的任意字段上执行可能较慢且重量级的查询，这可能会暴露隐私信息，甚至可能将集群拖垮</p>
<p>在生产中，我们还是更偏向于使用<code>request body</code>查询API，但是在那之前，我们需要了解数据在ES中是如何被索引的</p>
<h2 id="映射和分析"><a href="#映射和分析" class="headerlink" title="映射和分析"></a>映射和分析</h2><p>在我们尝试索引数据时，会发现一些奇怪的事情，比如下面这种情况：</p>
<p>在我们的集群中，有12条数据，其中只有一条数据包含<code>2014-09-15</code>这个值，但是通过不同的查询会有不同地命中总数</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">GET /_search?q=<span class="number">2014</span>              # <span class="number">12</span> results</span><br><span class="line">GET /_search?q=<span class="number">2014</span><span class="number">-09</span><span class="number">-15</span>        # <span class="number">12</span> results !</span><br><span class="line">GET /_search?q=date:<span class="number">2014</span><span class="number">-09</span><span class="number">-15</span>   # <span class="number">1</span>  result</span><br><span class="line">GET /_search?q=date:<span class="number">2014</span>         # <span class="number">0</span>  results !</span><br></pre></td></tr></table></figure>

<p>我们发现，在<code>_all</code>字段查询日期时，会返回所有文档，而在<code>date</code>字段只查询年份又没有返回文档</p>
<p>这是因为在<code>_all</code>字段和<code>date</code>字段的索引方式不同，现在来伪造一个请求，看一看ES如何解析我们的文档结构：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /gb/_mapping/tweet</span><br></pre></td></tr></table></figure>

<p>我们会得到以下结果</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   <span class="attr">&quot;gb&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">         <span class="attr">&quot;tweet&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;properties&quot;</span>: &#123;</span><br><span class="line">               <span class="attr">&quot;date&quot;</span>: &#123;</span><br><span class="line">                  <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;date&quot;</span>,</span><br><span class="line">                  <span class="attr">&quot;format&quot;</span>: <span class="string">&quot;strict_date_optional_time||epoch_millis&quot;</span></span><br><span class="line">               &#125;,</span><br><span class="line">               <span class="attr">&quot;name&quot;</span>: &#123;</span><br><span class="line">                  <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;string&quot;</span></span><br><span class="line">               &#125;,</span><br><span class="line">               <span class="attr">&quot;tweet&quot;</span>: &#123;</span><br><span class="line">                  <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;string&quot;</span></span><br><span class="line">               &#125;,</span><br><span class="line">               <span class="attr">&quot;user_id&quot;</span>: &#123;</span><br><span class="line">                  <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;long&quot;</span></span><br><span class="line">               &#125;</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在这里，ES为我们动态产生了一个映射，这个响应告诉我们date字段被认为是<code>date</code>类型的。由于<code>_all</code>是默认字段，所以没有提及，但是要知道<code>_all</code>字段是<code>string</code>类型的</p>
<p><code>date</code>字段与<code>string</code>字段索引方式不同，因此搜索结果也不一样。</p>
<p>他们最大的差异在于代表精确值的字段和代表全文的字段。这个区别非常重要</p>
<h3 id="精确值-VS-全文"><a href="#精确值-VS-全文" class="headerlink" title="精确值 VS 全文"></a>精确值 VS 全文</h3><p>在ES中，数据可以分为两类：精确值和全文</p>
<p>精确值：顾名思义，如同挺起来那样精确，例如用户ID和日期，用户名与邮箱地址，对于精确值来说，<code>Foo</code>和<code>foo</code>不同，<code>2014</code>与<code>2014-09-15</code>也不同</p>
<p>全文指的是文本数据，例如一个推文的内容或一封邮件的内容。</p>
<p>精确值很容易查询，结果只有匹配或不匹配</p>
<p>相比之下，全文查询数据要微妙得多，我们不仅仅要看<code>文档匹配吗</code>，还要看<code>这个文档有多匹配</code></p>
<p>我们不会对文档做全文类型的精确匹配。相反，我们希望在文本类的域中搜索，不仅如此，我们还希望能够搜索能够理解我们的意图：</p>
<ul>
<li>搜索<code>UK</code>，会返回包含<code>United Kindom</code>的文档</li>
<li>搜索<code>jump</code>，会匹配<code>jumped</code>、<code>jumps</code>、<code>jumping</code>甚至是<code>leap</code></li>
<li>搜索<code>jognny walker</code>会匹配<code>Johnnie Walker</code>、<code>johnnie deep</code>应该匹配<code>Johnny Depp</code></li>
<li><code>fox news hunting</code>应该返回关于狩猎的故事和猎狐的故事</li>
</ul>
<p>为了促进这类在全文域的查询，ES会对文档进行分析，然后对结果创建倒排索引</p>
<h3 id="倒排索引"><a href="#倒排索引" class="headerlink" title="倒排索引"></a>倒排索引</h3><p>为了快速的进行全文搜索，ES使用了一种叫做倒排索引的结构。</p>
<p>一个倒排索引由文档中所有不重复词的列表构成，对于其中每个词，有一个包含它的文档列表。</p>
<p>假设我们现在有两个文档，他们的<code>content</code>字段如下：</p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">The quick brown fox jumped over the lazy dog</span><br><span class="line">Quick brown foxes leap over lazy dogs in summer</span><br></pre></td></tr></table></figure>

<p>为了创建倒排索引，我们首先需要将文档中的<code>content</code>进行分词，创建一个包含有不重复词条的排序列表，然后列出每个词条出现在哪个文档，结果如下：</p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Term      Doc<span class="built_in">_</span>1  Doc<span class="built_in">_</span>2</span><br><span class="line">-------------------------</span><br><span class="line">Quick   |       |  X</span><br><span class="line">The     |   X   |</span><br><span class="line">brown   |   X   |  X</span><br><span class="line">dog     |   X   |</span><br><span class="line">dogs    |       |  X</span><br><span class="line">fox     |   X   |</span><br><span class="line">foxes   |       |  X</span><br><span class="line">in      |       |  X</span><br><span class="line">jumped  |   X   |</span><br><span class="line">lazy    |   X   |  X</span><br><span class="line">leap    |       |  X</span><br><span class="line">over    |   X   |  X</span><br><span class="line">quick   |   X   |</span><br><span class="line">summer  |       |  X</span><br><span class="line">the     |   X   |</span><br><span class="line">------------------------</span><br></pre></td></tr></table></figure>

<p>比如现在我们想搜索<code>quick brown</code>，我们只需要查找包含每个词条的文档</p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Term      Doc<span class="built_in">_</span>1  Doc<span class="built_in">_</span>2</span><br><span class="line">-------------------------</span><br><span class="line">brown   |   X   |  X</span><br><span class="line">quick   |   X   |</span><br><span class="line">------------------------</span><br><span class="line">Total   |   2   |  1</span><br></pre></td></tr></table></figure>

<p>虽然两个文档都有匹配，但是文档1匹配度更高。</p>
<p>但是，目前的倒排索引有一些问题：</p>
<ul>
<li><code>Quick</code>和<code>quick</code>以独立的词条出现，然而用户可能认为他们是相同的</li>
<li><code>fox</code>和<code>foxes</code>非常相似，就像<code>dog</code>和<code>dogs</code>，他们有相同的词根</li>
<li>更过分一点的，<code>jumped</code>和<code>leap</code>，尽管没有相同词根，但是他们是近义词</li>
</ul>
<p>为了找到与用户搜索的词条完全不一致，但是有足够相关性的文档，我们可以：</p>
<ul>
<li><code>Quick</code>转化为小写<code>quick</code></li>
<li><code>foxes</code>可以词干提取为<code>fox</code>。类似的，<code>dogs</code>可以提取为<code>dog</code></li>
<li><code>jumped</code>和<code>leap</code>是同义词，可以索引为相同的单词<code>jump</code></li>
</ul>
<p>然后索引就会变成这样</p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Term      Doc<span class="built_in">_</span>1  Doc<span class="built_in">_</span>2</span><br><span class="line">-------------------------</span><br><span class="line">brown   |   X   |  X</span><br><span class="line">dog     |   X   |  X</span><br><span class="line">fox     |   X   |  X</span><br><span class="line">in      |       |  X</span><br><span class="line">jump    |   X   |  X</span><br><span class="line">lazy    |   X   |  X</span><br><span class="line">over    |   X   |  X</span><br><span class="line">quick   |   X   |  X</span><br><span class="line">summer  |       |  X</span><br><span class="line">the     |   X   |  X</span><br><span class="line">------------------------</span><br></pre></td></tr></table></figure>

<p>但这还远远不够，我们只是对索引进行了转化，但是搜索<code>Quick fox</code>仍然会失败，因为在我们的索引中已经没有<code>Quick0</code>了，但是如果我们对搜索的字符串使用与<code>content</code>域相同的标准化规则，会变成查询<code>quick fox</code>，这样两个文档就都会匹配</p>
<p>这个分词和标准化的过程称为<strong>分析</strong></p>
<h3 id="分析和分析器"><a href="#分析和分析器" class="headerlink" title="分析和分析器"></a>分析和分析器</h3><p>分析包含如下内容：</p>
<ul>
<li>将文本拆分成适合用于倒排索引的独立词条</li>
<li>将这些词条统一化为标准格式以提高他们的可搜索性</li>
</ul>
<p>分析过程由分析器执行，分析器实际上是将三个功能封装到了一个包里：</p>
<ul>
<li><p>字符过滤器：字符串按照顺序通过每个字符过滤器，一个字符过滤器可以用来去掉HTML，或者将<code>&amp;</code>转化为<code>and</code></p>
</li>
<li><p>分词器：字符串被分词器分为单个的词条。一个简单地分词器遇到空格和标点的时候，可能会将文本拆分成词条</p>
</li>
<li><p>token过滤器：词条按顺序通过词条过滤器，在这个过程中可能会进行如下操作</p>
<ul>
<li>改变词条，比如将大写转化为小写</li>
<li>删除词条，比如<code>a</code>、<code>and</code>等无用词条</li>
<li>增加词条，比如增加同义词</li>
</ul>
<p>ES为我们提供了开箱即用的字符过滤器、分词器和token过滤器。</p>
</li>
</ul>
<h4 id="内置分析器"><a href="#内置分析器" class="headerlink" title="内置分析器"></a>内置分析器</h4><p>ES提供了可以直接使用的分析器，接下来会介绍最重要的几个分析器以及他们的区别</p>
<p>内置分析器有：</p>
<ul>
<li>标准分析器</li>
<li>简单分析器</li>
<li>空格分析器</li>
<li>语言分析器</li>
</ul>
<p>对于同一段话，他们分析出来的结果是不同的，比如下面这句话</p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;Set the shape to semi-transparent by calling set<span class="built_in">_</span>trans(5)&quot;</span><br></pre></td></tr></table></figure>

<h5 id="标准分析器"><a href="#标准分析器" class="headerlink" title="标准分析器"></a>标准分析器</h5><p>这是ES的默认分析器，他也是分析各种语言文本最常用的选择，根据Unicode联盟定义的单词边界划分文本，删除绝大部分标点，最后将词条小写</p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set, the, shape, to, semi, transparent, by, calling, set<span class="built_in">_</span>trans, 5</span><br></pre></td></tr></table></figure>

<h5 id="简单分析器"><a href="#简单分析器" class="headerlink" title="简单分析器"></a>简单分析器</h5><p>简单分析器在任何不是字母的地方分割文本，将词条小写</p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set, the, shape, to, semi, transparent, by, calling, set, trans</span><br></pre></td></tr></table></figure>

<h5 id="空格分析器"><a href="#空格分析器" class="headerlink" title="空格分析器"></a>空格分析器</h5><p>在空格的地方分割文本</p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Set, the, shape, to, semi-transparent, by, calling, set<span class="built_in">_</span>trans(5)</span><br></pre></td></tr></table></figure>

<h5 id="语言分析器"><a href="#语言分析器" class="headerlink" title="语言分析器"></a>语言分析器</h5><p>这个可以用于很多语言。他们可以考虑指定语言的特点。例如，英语分析器附带了一组英语无用词，例如<code>and</code>或<code>the</code>，他们对相关性没有多少影响，会被删除。由于理解英语语法的规则，这个分析器可以提取英语单词的词干。</p>
<p>英语分词器会产生以下词条：</p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set, shape, semi, transpar, call, set<span class="built_in">_</span>tran, 5</span><br></pre></td></tr></table></figure>

<p>有些单词甚至变成了词根式</p>
<h4 id="什么时候使用分析器"><a href="#什么时候使用分析器" class="headerlink" title="什么时候使用分析器"></a>什么时候使用分析器</h4><p>当我们索引一个文档，它的全文域被分析成词条以用来创建倒排索引。但是，当我们在全文域进行搜索时，我们需要将查询字符串通过一定的分析过程，来保证我们搜索的词条格式与索引中的格式一致。</p>
<ul>
<li>当查询一个全文域时，会对查询字符串应用相同的分析器，以产生正确的搜索分词列表</li>
<li>当查询精确值域时，就不会使用分析器</li>
</ul>
<p>现在我们就可以理解在刚开始的时候，为什么会出现那样的查询结果</p>
<h4 id="测试分析器"><a href="#测试分析器" class="headerlink" title="测试分析器"></a>测试分析器</h4><p>如果你还是很难理解分词的过程和实际被存储到索引中的词条，可以使用<code>analyze</code>API来查看文本时如何被分析的：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">GET /_analyze</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;analyzer&quot;</span>: <span class="string">&quot;standard&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;text&quot;</span>: <span class="string">&quot;Text to analyze&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>响应体：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   <span class="attr">&quot;tokens&quot;</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">         <span class="attr">&quot;token&quot;</span>:        <span class="string">&quot;text&quot;</span>,</span><br><span class="line">         <span class="attr">&quot;start_offset&quot;</span>: <span class="number">0</span>,</span><br><span class="line">         <span class="attr">&quot;end_offset&quot;</span>:   <span class="number">4</span>,</span><br><span class="line">         <span class="attr">&quot;type&quot;</span>:         <span class="string">&quot;&lt;ALPHANUM&gt;&quot;</span>,</span><br><span class="line">         <span class="attr">&quot;position&quot;</span>:     <span class="number">1</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">         <span class="attr">&quot;token&quot;</span>:        <span class="string">&quot;to&quot;</span>,</span><br><span class="line">         <span class="attr">&quot;start_offset&quot;</span>: <span class="number">5</span>,</span><br><span class="line">         <span class="attr">&quot;end_offset&quot;</span>:   <span class="number">7</span>,</span><br><span class="line">         <span class="attr">&quot;type&quot;</span>:         <span class="string">&quot;&lt;ALPHANUM&gt;&quot;</span>,</span><br><span class="line">         <span class="attr">&quot;position&quot;</span>:     <span class="number">2</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">         <span class="attr">&quot;token&quot;</span>:        <span class="string">&quot;analyze&quot;</span>,</span><br><span class="line">         <span class="attr">&quot;start_offset&quot;</span>: <span class="number">8</span>,</span><br><span class="line">         <span class="attr">&quot;end_offset&quot;</span>:   <span class="number">15</span>,</span><br><span class="line">         <span class="attr">&quot;type&quot;</span>:         <span class="string">&quot;&lt;ALPHANUM&gt;&quot;</span>,</span><br><span class="line">         <span class="attr">&quot;position&quot;</span>:     <span class="number">3</span></span><br><span class="line">      &#125;</span><br><span class="line">   ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>token</code>中，每个元素就代表一个单独的词条。</p>
<p>在响应体中，<code>token</code>是实际存储到索引中的词条，<code>position</code>是词条在原始文本中出现的位置，<code>start_offset</code>和<code>end_offset</code>则是字符在圆石字符串中出现的位置。</p>
<p><code>analyze</code>API是一个非常有用的工具，随着对ES了解的逐渐加深，我们会继续对它进行讨论。</p>
<p>还记得之前说的四种内置分析器吗，在ES中，标准分析器是默认的分析器，如果想要换一个分析器，我们就必须指定这些域的映射。</p>
<h3 id="映射"><a href="#映射" class="headerlink" title="映射"></a>映射</h3><p>为了能够让ES中存储的数据是我们想要的类型，我们需要给ES设置映射让ES知道每个域中数据的类型是什么。</p>
<p>ES中的简单域类型：</p>
<ul>
<li>字符串：string</li>
<li>整数：byte、short、integer、long</li>
<li>浮点数：float、double</li>
<li>布尔型：boolean</li>
<li>日期：date</li>
</ul>
<p>当我们索引一个包含新域的文档时，ES或使用动态映射，通过JSON中基本数据类型去猜测域类型，规则如下：</p>
<table>
<thead>
<tr>
<th>JSON Type</th>
<th>域Type</th>
</tr>
</thead>
<tbody><tr>
<td>布尔型：true或false</td>
<td>boolean</td>
</tr>
<tr>
<td>整数：123</td>
<td>long</td>
</tr>
<tr>
<td>浮点数</td>
<td>double</td>
</tr>
<tr>
<td>字符串，有效日期：2014-09-15</td>
<td>date</td>
</tr>
<tr>
<td>字符串</td>
<td>string</td>
</tr>
</tbody></table>
<p>当然，如果通过引号索引一个数字，它将被映射为string</p>
<h4 id="查看映射"><a href="#查看映射" class="headerlink" title="查看映射"></a>查看映射</h4><p>通过<code>/_mapping</code>，我们可以查看ES中一个过着多个索引类型的映射：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /gb/_mapping/tweet</span><br></pre></td></tr></table></figure>

<p>映射：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   <span class="attr">&quot;gb&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">         <span class="attr">&quot;tweet&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;properties&quot;</span>: &#123;</span><br><span class="line">               <span class="attr">&quot;date&quot;</span>: &#123;</span><br><span class="line">                  <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;date&quot;</span>,</span><br><span class="line">                  <span class="attr">&quot;format&quot;</span>: <span class="string">&quot;strict_date_optional_time||epoch_millis&quot;</span></span><br><span class="line">               &#125;,</span><br><span class="line">               <span class="attr">&quot;name&quot;</span>: &#123;</span><br><span class="line">                  <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;string&quot;</span></span><br><span class="line">               &#125;,</span><br><span class="line">               <span class="attr">&quot;tweet&quot;</span>: &#123;</span><br><span class="line">                  <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;string&quot;</span></span><br><span class="line">               &#125;,</span><br><span class="line">               <span class="attr">&quot;user_id&quot;</span>: &#123;</span><br><span class="line">                  <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;long&quot;</span></span><br><span class="line">               &#125;</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="自定义域映射"><a href="#自定义域映射" class="headerlink" title="自定义域映射"></a>自定义域映射</h4><p>在大多数情况下，基本域数据类型已经够用了，但是我们经常要为单独域自定义映射，它允许我们进行一些操作：</p>
<ul>
<li>全文字符串和精确字符串域的区别</li>
<li>使用特定的语言分析器</li>
<li>优化域以适应部分匹配</li>
<li>指定自定义数据格式</li>
</ul>
<p>域最重要的属性是<code>type</code>，如果想要设置的属性不是<code>string</code>域，我们只需要</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    number_of_clicks: &#123;</span><br><span class="line">        <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;integer&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>而对于string类型，string类型会被认为包含全文。也就是说该域的值在经过索引前，会通过一个分析器，针对这个域的查询在搜索前也会经过一个分析器</p>
<p><code>string</code>域映射的两个最重要的属性是<code>index</code>和<code>analyzer</code></p>
<h5 id="index-1"><a href="#index-1" class="headerlink" title="index"></a>index</h5><p>index属性通过以下三个值来控制怎样索引字符串：</p>
<ul>
<li>analyzed：默认，首先分析字符串，然后索引它，也就是全文索引</li>
<li>not_analyzed：索引这个域，让他能够被搜索到，但搜索的是精确值</li>
<li>no：不索引这个域，这个域不会被搜索到</li>
</ul>
<p>如果我们想要索引某个字段为精确值，我们可以这样：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;tag&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;string&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;index&quot;</span>: <span class="string">&quot;not_analyzed&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="analyzer"><a href="#analyzer" class="headerlink" title="analyzer"></a>analyzer</h5><p><code>analyzer</code>可以指定在搜索和索引时使用的分析器。在ES中，默认使用的是<code>standard</code>分析器，但是我们可以更换为内置分析器，比如<code>whitespace</code>、<code>simple</code>、<code>english</code>：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;tweet&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;string&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;analyzer&quot;</span>: <span class="string">&quot;english&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="更新映射"><a href="#更新映射" class="headerlink" title="更新映射"></a>更新映射</h4><p>当我们首次创建某个索引时，可以指定类型的映射。也可以使用<code>/_mapping</code>为新类型增加映射。</p>
<p><strong>注意</strong>：我们只能增加一个不存在的映射，但是不能修改存在的域映射，否则索引的数据可能会出错，以至于不能被正常搜索</p>
<p>接下来创建一个索引，指定<code>tweet</code>域使用<code>english</code>分析器</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">PUT /gb </span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;tweet&quot;</span> : &#123;</span><br><span class="line">      <span class="attr">&quot;properties&quot;</span> : &#123;</span><br><span class="line">        <span class="attr">&quot;tweet&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;type&quot;</span> :    <span class="string">&quot;string&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;analyzer&quot;</span>: <span class="string">&quot;english&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;date&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;type&quot;</span> :   <span class="string">&quot;date&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;name&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;type&quot;</span> :   <span class="string">&quot;string&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;user_id&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;type&quot;</span> :   <span class="string">&quot;long&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后在<code>tweet</code>域增加一个名为<code>tag</code>的<code>not_analyzed</code>文本域</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">PUT /gb/_mapping/tweet</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;properties&quot;</span> : &#123;</span><br><span class="line">    <span class="attr">&quot;tag&quot;</span> : &#123;</span><br><span class="line">      <span class="attr">&quot;type&quot;</span> :    <span class="string">&quot;string&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;index&quot;</span>:    <span class="string">&quot;not_analyzed&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>












































        
        <br />
        <div id="comment-container">
        </div>
        <div id="disqus_thread"></div>
        <div id="lv-container"></div>
        <div class="giscus"></div>
    </div>
</div>

    </div>
</div>


<footer class="footer">
    <ul class="list-inline text-center">
        
        

        

        

        
        <li>
            <a target="_blank"  href="https://github.com/JiangLiuJL">
                            <span class="fa-stack fa-lg">
                                <i class="iconfont icon-github"></i>
                            </span>
            </a>
        </li>
        

        

    </ul>
    
    <p>
        <span>/</span>
        
        <span><a target="_blank" rel="noopener" href="https://qm.qq.com/cgi-bin/qm/qr?k=ZJIyoBCxTJBHdyrsTC-0bZ6_wV7v8ztt&amp;noverify=0">联系我</a></span>
        <span>/</span>
        
        <span><a href="https://jiangliujl.github.io/about/">JiangLiu&#39;s Page</a></span>
        <span>/</span>
        
        <span><a href="#">It helps SEO</a></span>
        <span>/</span>
        
    </p>
    
    <p>
        <span id="busuanzi_container_site_pv">
            <span id="busuanzi_value_site_pv"></span>PV
        </span>
        <span id="busuanzi_container_site_uv">
            <span id="busuanzi_value_site_uv"></span>UV
        </span>
        Created By <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a>  Theme <a target="_blank" rel="noopener" href="https://github.com/aircloud/hexo-theme-aircloud">AirCloud</a></p>
</footer>




</body>

<script>
    // We expose some of the variables needed by the front end
    window.hexo_search_path = "search.json"
    window.hexo_root = "/"
    window.isPost = true
</script>
<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>

<script src="/js/index.js"></script>

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




    <script src="https://giscus.app/client.js"
    data-repo="aircloud/hexo-aircloud-blog"
    data-repo-id="MDEwOlJlcG9zaXRvcnkxMjkwNDgyNjg="
    data-category="Announcements"
    data-category-id="DIC_kwDOB7EezM4COhKJ"
    data-mapping="title"
    data-reactions-enabled="1"
    data-emit-metadata="0"
    data-input-position="bottom"
    data-theme="light"
    data-lang="zh-CN"
    crossorigin="anonymous"
    async>
</script>




</html>
